import streamlit as st
import time

def main():
    """
    Streamlit tabanlı Pomodoro Timer uygulamasının ana fonksiyonu.
    Geri sayım, süre ayarları ve ses seçenekleri içerir.
    """
    st.set_page_config(
        page_title="Streamlit Pomodoro Timer",
        layout="centered",
        initial_sidebar_state="auto"
    )

    st.title("Pomodoro Timer")
    st.markdown("Zamanınızı verimli kullanmak için Pomodoro tekniğini kullanın!")

    # Oturum durumunu (session state) kullanarak sayaç ve durumları sakla
    if 'is_running' not in st.session_state:
        st.session_state.is_running = False
    if 'current_time' not in st.session_state:
        st.session_state.current_time = 0
    if 'state' not in st.session_state:
        st.session_state.state = 'work' # 'work' veya 'break'
    if 'ambient_sound_playing' not in st.session_state:
        st.session_state.ambient_sound_playing = False

    # Süreleri kullanıcıdan al
    st.sidebar.header("Süre Ayarları")
    work_minutes = st.sidebar.slider("Çalışma Süresi (dk)", 1, 60, 25)
    break_minutes = st.sidebar.slider("Mola Süresi (dk)", 1, 30, 5)

    # Sesleri kullanıcıdan al
    st.sidebar.header("Ses Ayarları")
    ambient_sound = st.sidebar.selectbox(
        "Arka Plan Sesi",
        options=["Yok", "Doğa Sesleri", "Ateş Çıtırtısı"]
    )
    end_sound = st.sidebar.selectbox(
        "Bitiş Sesi",
        options=["Zil Sesi", "Gong Sesi"]
    )

    # Ses dosyalarının URL'leri
    AMBIENT_SOUNDS = {
        "Doğa Sesleri": "https://cdn.pixabay.com/audio/2023/08/17/ambient-nature-sounds-170702.mp3",
        "Ateş Çıtırtısı": "https://cdn.pixabay.com/audio/2023/11/15/fire-crackle-190623.mp3",
        "Yok": ""
    }
    END_SOUNDS = {
        "Zil Sesi": "https://cdn.pixabay.com/audio/2021/04/13/bell-15-10331.mp3",
        "Gong Sesi": "https://cdn.pixabay.com/audio/2021/08/04/gong-sound-49520.mp3"
    }

    # Sesleri çalmak için placeholder
    audio_placeholder = st.empty()

    # Butonlar
    col1, col2 = st.columns([1, 1])
    with col1:
        if st.button("Başlat", use_container_width=True):
            st.session_state.is_running = True
            if st.session_state.state == 'work':
                st.session_state.current_time = work_minutes * 60
            else:
                st.session_state.current_time = break_minutes * 60

            # Seçilen ortam sesini çalmaya başla
            if ambient_sound != "Yok":
                st.session_state.ambient_sound_playing = True
    
    with col2:
        if st.button("Sıfırla", use_container_width=True):
            st.session_state.is_running = False
            st.session_state.current_time = work_minutes * 60
            st.session_state.state = 'work'
            st.session_state.ambient_sound_playing = False
            st.experimental_rerun()

    placeholder = st.empty()

    if st.session_state.is_running:
        # Ortam sesini çal (eğer seçilmişse)
        if st.session_state.ambient_sound_playing:
            audio_placeholder.audio(AMBIENT_SOUNDS[ambient_sound], format="audio/mp3", loop=True)
            
        while st.session_state.current_time > 0:
            minutes, seconds = divmod(st.session_state.current_time, 60)
            
            # Geri sayımı biçimlendir ve göster
            time_display = f"{minutes:02d}:{seconds:02d}"
            placeholder.header(f"Zaman: {time_display}")
            
            # Güncel durumu göster
            if st.session_state.state == 'work':
                st.markdown("### Çalışma Zamanı!")
            else:
                st.markdown("### Mola Zamanı!")

            time.sleep(1)
            st.session_state.current_time -= 1

            # Uygulamanın anlık olarak güncellenmesini sağla
            st.experimental_rerun()
        
        # Süre bittiğinde
        st.session_state.is_running = False
        st.session_state.ambient_sound_playing = False # Ortam sesini durdur
        audio_placeholder.empty() # Ses placeholder'ını temizle

        if st.session_state.state == 'work':
            st.success("Çalışma süreniz bitti! Harika iş çıkardınız.")
            st.session_state.state = 'break'
            st.session_state.current_time = break_minutes * 60
        else:
            st.success("Mola süreniz bitti! Yeni seansa başlayabilirsiniz.")
            st.session_state.state = 'work'
            st.session_state.current_time = work_minutes * 60
        
        # Bitiş sesini çal
        st.audio(END_SOUNDS[end_sound], format="audio/mp3", start_time=0)
        
        st.experimental_rerun()

    else:
        # Uygulama durduğunda veya yeni başladığında
        minutes, seconds = divmod(st.session_state.current_time, 60)
        time_display = f"{minutes:02d}:{seconds:02d}"
        if st.session_state.state == 'work':
            placeholder.header(f"Zaman: {time_display} (Çalışmaya Hazır)")
        else:
            placeholder.header(f"Zaman: {time_display} (Molaya Hazır)")

if __name__ == "__main__":
    main()
